language: java
sudo: required
dist: trusty
services:
      - docker
matrix:
   include:
      - jdk: oraclejdk7
        os: linux
        env: PROJ=artoolkitplus OS=linux-x86_64
      - jdk: oraclejdk7
        os: linux
        env: PROJ=opencv:chilitags:flandmark:mxnet:caffe OS=linux-x86_64
      - jdk: oraclejdk7
        os: linux
        env: PROJ=cuda OS=linux-x86_64
      - jdk: oraclejdk7
        os: linux
        env: PROJ=ffmpeg OS=linux-x86_64
      - jdk: oraclejdk7
        os: linux
        env: PROJ=fftw OS=linux-x86_64
      - jdk: oraclejdk7
        os: linux
        env: PROJ=openblas OS=linux-x86_64
      - jdk: oraclejdk7
        os: linux
        env: PROJ=gsl OS=linux-x86_64
      - jdk: oraclejdk7
        os: linux
        env: PROJ=leptonica:tesseract OS=linux-x86_64
      - jdk: oraclejdk7
        os: linux
        env: PROJ=libdc1394 OS=linux-x86_64
      - jdk: oraclejdk7
        os: linux
        env: PROJ=libfreenect OS=linux-x86_64
      - jdk: oraclejdk7
        os: linux
        env: PROJ=llvm OS=linux-x86_64
      - jdk: oraclejdk7
        os: linux
        env: PROJ=tensorflow OS=linux-x86_64
      - jdk: oraclejdk7
        os: linux
        env: PROJ=videoinput OS=linux-x86_64

before_install:
   #maybe this needs to go into new first job
   - git clone https://github.com/bytedeco/javacpp.git
   - cd javacpp
   - git checkout d7d6af2b4a2d5e5d3ea48cb27248e2f84a031fd2 
   - mvn install -Dmaven.test.skip=true -Dmaven.javadoc.skip=true
   - cd ..
   - export PYTHON_BIN_PATH=$(which python) # For tensorflow
   - IFS=':' read -ra PROJ <<< "$PROJ"
   - if [ "$TRAVIS_OS_NAME" == "osx" ]; then 
      export JAVA_HOME=$(/usr/libexec/java_home); 
     fi
   - |
      if [ "$TRAVIS_OS_NAME" == "linux" ]; then
        if [ "$OS" == "linux-x86" ]; then
          sudo dpkg --add-architecture i386
          sudo apt-get update
          #echo 'DOCKER_OPTS="-H tcp://127.0.0.1:2375 -H unix:///var/run/docker.sock -s devicemapper"' | sudo tee /etc/default/docker > /dev/null
          #sudo service docker restart
          #sleep 5
          #sudo docker pull centos:7
          #sudo docker pull nvidia/cuda:8.0-cudnn5-devel-centos7
        fi
        if [ "$OS" == "linux-x86_64" ]; then
          echo "starting docker"
          if [ "${PROJ[0]}" == "cuda" ] || [ "${PROJ[0]}" == "tensorflow" ]; then
            docker run --privileged -d -ti -e "container=docker" -v $HOME/.m2/:/root/.m2/ -v $HOME/build/:/root/build/ -v /sys/fs/cgroup:/sys/fs/cgroup nvidia/cuda:8.0-cudnn5-devel-centos7 /usr/sbin/init
          else
            docker run --privileged -d -ti -e "container=docker" -v $HOME/.m2/:/root/.m2/ -v $HOME/build/:/root/build/ -v /sys/fs/cgroup:/sys/fs/cgroup centos:centos7 /usr/sbin/init
          fi
          DOCKER_CONTAINER_ID=$(docker ps | grep centos | awk '{print $1}')
          echo "container id is $DOCKER_CONTAINER_ID"
          docker exec -ti $DOCKER_CONTAINER_ID /bin/bash -xec "yum -y install epel-release" > /dev/null
          docker exec -ti $DOCKER_CONTAINER_ID /bin/bash -xec "yum -y install clang gcc-c++ gcc-gfortran java-devel maven python numpy swig git file which wget unzip tar bzip2 gzip xz patch make cmake3 perl nasm yasm alsa-lib-devel freeglut-devel glfw-devel gtk2-devel libusb-devel libusb1-devel zlib-devel openblas-devel" > /dev/null
          if [ "${PROJ[0]}" == "tensorflow" ]; then
           docker exec -ti $DOCKER_CONTAINER_ID /bin/bash -xec "curl -L  https://github.com/bazelbuild/bazel/releases/download/0.4.4/bazel-0.4.4-installer-linux-x86_64.sh -o bazel.sh"
           docker exec -ti $DOCKER_CONTAINER_ID /bin/bash -xec "bash bazel.sh"
          fi 
        fi
      else
        brew install yasm nasm
      fi
   - |
      if [ "$PROJ" == "tensorflow" ]; then
        if [ "$TRAVIS_OS_NAME" == "linux" ]; then
          #sudo apt-get install -q -y swig python-numpy
          echo "not needed "
        else
          brew tap homebrew/python
          brew install swig numpy
        fi
      fi
   - |
      if [ "${PROJ[0]}" == "opencv" ]; then
        if [ "$TRAVIS_OS_NAME" == "linux" ]; then
          if [ "$OS" == "linux-x86" ]; then
            sudo apt-get install -q -y yasm:i386 nasm:i386 libc6:i386 libncurses5:i386 libstdc++6:i386 gcc-multilib g++-multilib libglib2.0-0:i386 libglib2.0-dev:i386
          fi
          #sudo apt-get install -q -y libblas-dev
        fi
      fi
install:
###   - ./cppbuild.sh -platform $OS install ${PROJ[@]}
   - echo "install"
script:
   - |
    echo "starting script"
    DOCKER_CONTAINER_ID=$(docker ps | grep centos | awk '{print $1}')
    echo "container id is $DOCKER_CONTAINER_ID"
    for proj in "${PROJ[@]}"; do
      echo "running for $proj"
      #if [ "$OS" == "linux-x86" ]; then
        docker exec -ti $DOCKER_CONTAINER_ID /bin/bash -xec "cd /root/build/vb216/javacpp-presets;mvn install -Dmaven.javadoc.skip=true -Djavacpp.platform=$OS -pl $proj"; export BUILD_STATUS=$?
        echo "Build status $BUILD_STATUS"
        if [ $BUILD_STATUS -ne 0 ]; then  
          echo "Build Failed"
          return $BUILD_STATUS
        fi
      #else	
      # mvn install -Dmaven.javadoc.skip=true -Djavacpp.platform=$OS -pl $proj
      #fi
    done
    docker stop $DOCKER_CONTAINER_ID
    docker rm -v $DOCKER_CONTAINER_ID
cache:
   directories:
      - $HOME/.m2

